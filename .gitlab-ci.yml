build:fedora:
  image: fedora:latest
  before_script:
    - dnf install -y git wget
    - . /etc/os-release
    - wget https://download1.rpmfusion.org/free/fedora/rpmfusion-free-release-$VERSION_ID.noarch.rpm
    - rpm -Uvh rpmfusion-free-release-$VERSION_ID.noarch.rpm

  script:
    - dnf remove meson ninja
    - dnf install -y python3 python3-pip opencv-devel clang SDL2-devel ffmpeg-devel gcc-c++ git wget git-lfs
    - python3 -m pip install --user meson ninja
    - meson setup build
    - meson compile -C build
    - meson test -C build
  only:
    - merge_requests
    - main

wiki:
  image: noasakurajin/latex:latest
  stage: deploy
  script:
    - echo 'echo $K8S_SECRET_GITLAB_TOKEN' > $HOME/.git-askpass && chmod +x $HOME/.git-askpass
    - export GIT_ASKPASS=$HOME/.git-askpass
    - git config --global url."https://api@git.thm.de/".insteadOf "https://git.thm.de/"
    - git config --global url."https://ssh@git.thm.de/".insteadOf "ssh://git@git.thm.de/"
    - git config --global url."https://git@git.thm.de/".insteadOf "git@git.thm.de:"
    - git config --global user.email "noah.kirschmann@mnd.thm.de"
    - git config --global user.name "Gitlab-Ci"
    - apt-get update
    - apt-get install --yes doxygen graphviz wget unzip make
    - wget https://github.com/matusnovak/doxybook2/releases/download/v1.2.3/doxybook2-linux-amd64-v1.2.3.zip
    - unzip doxybook2-linux-amd64-v1.2.3.zip -d doxybook
    - doxygen
    - git clone git@git.thm.de:bahn-simulator/libtrainsim.wiki.git doc/md
    - ./doxybook/bin/doxybook2 -i doc/xml -o doc/md -c docs/config.json
    - cd doc/md
    - git add .
    - git commit -m "updated docs"
    - git push -f
    - cd ../latex
    - make
    - cd ../..
    - mv doc/latex/refman.pdf refman_en.pdf
  only:
    - main

  artifacts:
    paths:
      - "reference_manual_en.pdf"

pages:
  image: alpine
  stage: deploy
  script:
    - apk update && apk add doxygen
    - doxygen Doxyfile
    - mv doc/html/ public/
  artifacts:
    paths:
      - public
  only:
    - main

